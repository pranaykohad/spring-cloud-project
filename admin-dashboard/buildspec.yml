version: 0.2

env:
  variables:
    AWS_REGION: ap-south-1
    ACCOUNT_ID: 978364619388
    ECR_REPO: admin-dashboard
    IMAGE_TAG: 0.0.1-SNAPSHOT

phases:
  install:
    runtime-versions:
      nodejs: 18

  pre_build:
    commands:
      - pwd
      - echo "Moving to directory" $ECR_REPO
      - cd $ECR_REPO
      - node -v
      - npm -v

      - echo "Installing dependencies"
      - npm ci --legacy-peer-deps

      - echo "Building Angular app"
      - npm run build -f Docker.prod -t admin-dashboard .

      - echo "Logging in to Amazon ECR"
      - aws ecr get-login-password --region $AWS_REGION |
        docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

  build:
    commands:
      - echo "Building Docker image"
      - docker build -t $ECR_REPO:$IMAGE_TAG .

      - echo "Tagging image"
      - docker tag $ECR_REPO:$IMAGE_TAG $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG
      - docker tag $ECR_REPO:$IMAGE_TAG $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest

  post_build:
    commands:
      - echo "Pushing images to ECR"
      - docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG
      - docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest

      - echo "Build completed successfully"
